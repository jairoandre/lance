<ui:composition template="/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:lance="http://java.sun.com/jsf/composite/lance"
                xmlns:uilance="http://vah.com.br/lance">

  <ui:define name="metadata">
    <f:metadata>
      <f:viewParam name="id" value="#{contractController.id}"/>
      <f:viewAction action="#{contractController.onLoad}"/>
    </f:metadata>
  </ui:define>

  <ui:define name="content">
    <h:form id="form">

      <!-- Modal de seleção de cliente -->
      <p:dialog id="subjectDlg" widgetVar="subjectDlg" modal="true"
                header="SELECIONAR CONTRATANTE" width="800">
        <p:ajax event="close" listener="#{contractController.onLoadSubject}"
                update=":#{p:component('subject')} :#{p:component('servicesContract')}"
                process="@this"/>
        <lance:dataTable id="subjectDlgTbl" controller="#{clientController}"
                         renderAddBtn="false" renderActionColumn="false">
          <p:column style="text-align: center;" width="50">
            <p:commandLink ajax="true" styleClass="action-link"
                           process="@this" update="@(.action-link)">
              <f:setPropertyActionListener value="#{item}"
                                           target="#{contractController.item.subject}"/>
              <h:panelGroup
                styleClass="fa fa#{(contractController.item.subject.id == item.id) ? '-dot' : ''}-circle-o"/>
            </p:commandLink>
          </p:column>
          <p:column sortBy="#{item.title}" headerText="Descrição"
                    style="text-align: left;">
            <h:outputText value="#{item.title}"/>
          </p:column>
        </lance:dataTable>

        <f:facet name="footer">
          <p:commandButton id="subjectDlgCloseBtn" ajax="true"
                           onclick="PF('subjectDlg').hide()" value="Fechar diálogo"/>
        </f:facet>

      </p:dialog>

      <lance:editForm id="contractPnl" controller="#{contractController}"
                      columns="3">
        <uilance:inputText id="name" label="Nome"
                           value="#{contractController.item.title}"
                           editing="#{contractController.editing}" required="true"/>
        <uilance:inputDate id="beginDate" label="Data de início"
                           value="#{contractController.item.beginDate}"
                           editing="#{contractController.editing}" required="true"/>
        <uilance:inputDate id="endDate" label="Data de término"
                           value="#{contractController.item.endDate}"
                           editing="#{contractController.editing}" required="true"/>
        <uilance:inputDate id="changeDate" label="Data de reajuste"
                           value="#{contractController.item.changeDate}"
                           editing="#{contractController.editing}" required="true"/>
        <uilance:manyToOne id="subject" dialog="subjectDlg"
                           editing="#{contractController.editing}" label="Contratante"
                           required="true" title="title"
                           value="#{contractController.item.subject}"/>

        <f:facet name="other">

          <h:panelGroup id="servicesContract"
                        styleClass="services-contract-panel" layout="block">

            <p:dataList id="contractSectorsDataList" var="contractSector"
                        emptyMessage="Sem setores" type="none"
                        rowIndexVar="idx"
                        value="#{contractController.item.contractSectors.toArray()}">

              <f:facet name="header">
                <h:outputText value="SETORES DO CONTRATANTE"/>
              </f:facet>

              <h:panelGroup id="servicesContractPnl" style="padding: 5px"
                            layout="block">

                <p:dialog id="serviceDlg"
                          widgetVar="serviceDlg#{idx}" modal="true"
                          header="SELECIONE OS SERVIÇOS" width="800">

                  <p:ajax event="close"
                          update="@(.servicePnl#{idx})"/>

                  <lance:dataTable id="serviceDlgTable"
                                   controller="#{contractController.serviceControllers[contractSector.sector.id]}"
                                   renderAddBtn="false"
                                   renderActionColumn="false">
                    <p:column id="selector" style="text-align: center;" width="50">
                      <p:commandLink ajax="true"
                                     action="#{contractController.toggleService(contractSector)}"
                                     styleClass="action-link" process="@this"
                                     update="@(.action-link)">
                        <f:setPropertyActionListener value="#{item}"
                                                     target="#{contractController.serviceBean}"/>
                        <h:panelGroup
                          styleClass="fa fa#{contractSector.services.contains(item) ? '-check' : ''}-square-o"/>
                      </p:commandLink>
                    </p:column>
                    <p:column id="detail" sortBy="#{item.title}"
                              headerText="Descrição" style="text-align: left;">
                      <h:outputText value="#{item.title}"/>
                    </p:column>
                  </lance:dataTable>

                  <f:facet name="footer">
                    <p:commandButton id="serviceDlgCloseBtn" ajax="true"
                                     onclick="PF('serviceDlg#{idx}').hide()"
                                     value="Fechar diálogo"/>
                  </f:facet>
                </p:dialog>

                <p:dialog id="tenantDlg"
                          widgetVar="tenantDlg#{idx}" modal="true"
                          header="SELECIONAR INQUILINO #{idx}" width="800" dynamic="true">
                  <p:ajax event="close" update="@(.tenant#{idx})"
                          process="@this"/>
                  <lance:dataTable id="tenantDlgTable"
                                   controller="#{contractController.clientControllers[contractSector.sector.id]}"
                                   renderAddBtn="false"
                                   renderActionColumn="false">
                    <p:column style="text-align: center;" width="50">
                      <p:commandLink ajax="true" styleClass="action-link"
                                     process="@this" update="@(.action-link)">
                        <f:setPropertyActionListener value="#{item}"
                                                     target="#{contractSector.tenant}"/>
                        <h:panelGroup
                          styleClass="fa fa#{(contractSector.tenant.id == item.id) ? '-dot' : ''}-circle-o"/>
                      </p:commandLink>
                    </p:column>
                    <p:column sortBy="#{item.title}" headerText="Descrição"
                              style="text-align: left;">
                      <h:outputText value="#{item.title}"/>
                    </p:column>
                  </lance:dataTable>

                  <f:facet name="footer">
                    <p:commandButton id="tenantDlgCloseBtn" ajax="true"
                                     onclick="PF('tenantDlg#{idx}').hide()"
                                     value="Fechar diálogo"/>
                  </f:facet>
                </p:dialog>

                <p:panel toggleable="true"
                         header="#{contractSector.sector == null ? 'Sem setor' : contractSector.sector.title}"
                         styleClass="tenant#{idx}">
                  <h:panelGroup id="servicePnl"
                                styleClass="servicePnl#{idx}">
                    <h:panelGrid id="servicePnlGrid" columns="3">
                      <uilance:manyToOne id="tenant"
                                         dialog="tenantDlg#{idx}"
                                         editing="#{contractController.editing}" label="Inquilino"
                                         required="false" title="title" value="#{contractSector.tenant}"/>
                    </h:panelGrid>
                    <p:commandButton id="serviceAddBtn"
                                     onclick="PF('serviceDlg#{idx}').show()"
                                     value="Relacionar serviços"
                                     rendered="#{contractController.editing}"
                                     style="margin-top: 10px"/>
                    <p:dataTable id="serviceTable" var="item"
                                 value="#{contractSector.services}" lazy="true"
                                 emptyMessage="Sem serviços relacionados"
                                 style="margin-top: 10px">
                      <p:column headerText="Serviços" style="text-align: left;">
                        <h:outputText value="#{item.title}"/>
                      </p:column>
                      <p:column width="100" headerText="Remover"
                                style="text-align: center;"
                                rendered="#{contractController.editing}">
                        <p:commandLink id="serviceTableRemoveBtn"
                                       action="#{contractController.toggleService(contractSector)}"
                                       ajax="true" styleClass="action-link" update="@form"
                                       process="@this">
                          <f:setPropertyActionListener value="#{item}"
                                                       target="#{contractController.serviceBean}"/>
                          <span class="fa fa-trash"/>
                        </p:commandLink>
                      </p:column>
                    </p:dataTable>
                  </h:panelGroup>
                </p:panel>
              </h:panelGroup>

            </p:dataList>


          </h:panelGroup>
        </f:facet>

      </lance:editForm>
    </h:form>
  </ui:define>
</ui:composition>