<ui:composition template="/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:lance="http://java.sun.com/jsf/composite/lance"
                xmlns:uilance="http://vah.com.br/lance">
  <ui:define name="metadata">
    <f:metadata>
      <f:viewParam name="id" value="#{entryController.id}"/>
      <f:viewParam name="serviceId" value="#{entryController.serviceId}"/>
      <f:viewAction action="#{entryController.onLoad}"/>
    </f:metadata>
  </ui:define>
  <ui:define name="content">
    <h:form id="form">
      <h:panelGroup id="container" layout="block" styleClass="lance-container">
        <p:panel header="Lançamento - #{entryController.item.service.title}">
          <ui:include src="totalBlock.xhtml"/>

          <h:panelGroup layout="block" style="float:left;">
            <h:panelGrid columns="2" cellpadding="10">
              <h:outputLabel value="Estado:" styleClass="label"/>
              <lance:entryStatus status="#{entryController.item.status}"/>
              <h:outputLabel value="Tipo:" styleClass="label"/>
              <h:outputText value="#{entryController.item.service.type.label}"/>
            </h:panelGrid>
            <h:panelGrid columns="2" cellpadding="10"
                         rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}">
              <uilance:inputCurrency id="totalAreas" label="Valor total a ratear"
                                     value="#{entryController.item.ammountToShare}" renderMessage="false">
                <p:ajax event="keyup" process="@this" update="areasValuesPnl"
                        listener="#{entryController.shareAmmount}"/>
              </uilance:inputCurrency>
            </h:panelGrid>
            <p:commandButton id="shareAmmountButton" value="Realizar rateio"
                             action="#{entryController.fillSharedFields}"
                             update="dataTable :#{p:component('totalValue')}"
                             rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}"/>
          </h:panelGroup>

          <h:panelGroup id="areasValuesPnl" layout="block" style="float:left;"
                        rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}">
            <h:panelGrid columns="4" cellpadding="10">
              <h:outputLabel value="Rateio VAH:" styleClass="label"/>
              <h:outputText value="#{entryController.ammoutVah}">
                <f:convertNumber type="currency" minFractionDigits="2" pattern="R$ #,##0.00"/>
              </h:outputText>
              <h:outputLabel value="Rateio Terceiros:" styleClass="label"/>
              <h:outputText value="#{entryController.ammountProviders}">
                <f:convertNumber type="currency" minFractionDigits="2" pattern="R$ #,##0.00"/>
              </h:outputText>
              <h:outputLabel value="Rateio Consultórios:" styleClass="label"/>
              <h:outputText value="#{entryController.ammountClinics}">
                <f:convertNumber type="currency" minFractionDigits="2" pattern="R$ #,##0.00"/>
              </h:outputText>
              <h:outputLabel value="Rateio Shopping:" styleClass="label"/>
              <h:outputText value="#{entryController.ammountShopping}">
                <f:convertNumber type="currency" minFractionDigits="2" pattern="R$ #,##0.00"/>
              </h:outputText>
              <h:outputLabel value="Taxa Terceiros:" styleClass="label"/>
              <h:outputText value="#{entryController.taxProviders}">
                <f:convertNumber type="currency" minFractionDigits="2" pattern="R$ #,##0.00"/>
              </h:outputText>
              <h:outputLabel value="Taxa Consultórios:" styleClass="label"/>
              <h:outputText value="#{entryController.taxClinics}">
                <f:convertNumber type="currency" minFractionDigits="2" pattern="R$ #,##0.00"/>
              </h:outputText>
              <h:outputLabel value="Taxa Shopping:" styleClass="label"/>
              <h:outputText value="#{entryController.taxShopping}">
                <f:convertNumber type="currency" minFractionDigits="2" pattern="R$ #,##0.00"/>
              </h:outputText>
            </h:panelGrid>
          </h:panelGroup>

          <!-- TAXAS E PERCENTUAIS -->

          <h:panelGroup id="taxesPnl" layout="block" style="float:left;">
            <h:panelGrid columns="4" cellpadding="10">
              <h:outputLabel value="Valor do serviço:" styleClass="label"
                             rendered="#{entryController.item.service.type == 'T'}"/>
              <h:outputText value="#{entryController.item.serviceValue.valueA}"
                            rendered="#{entryController.item.service.type == 'T'}">
                <f:convertNumber type="currency" minFractionDigits="2" pattern="R$ #,##0.00"/>
              </h:outputText>
              <h:outputLabel value="Tarifa fora de ponta:" styleClass="label"
                             rendered="#{entryController.item.service.type == 'E'}"/>
              <h:outputText value="#{entryController.item.serviceValue.valueA}"
                            rendered="#{entryController.item.service.type == 'E'}">
                <f:convertNumber type="currency" minFractionDigits="2" pattern="R$ #,##0.00"/>
              </h:outputText>
              <h:outputLabel value="Percentual fora de ponta:" styleClass="label"
                             rendered="#{entryController.item.service.type == 'E'}"/>
              <h:outputText value="#{entryController.item.serviceValue.valueB}"
                            rendered="#{entryController.item.service.type == 'E'}">
                <f:convertNumber type="percent" minFractionDigits="2"/>
              </h:outputText>
              <h:outputLabel value="Tarifa de ponta:" styleClass="label"
                             rendered="#{entryController.item.service.type == 'E'}"/>
              <h:outputText value="#{entryController.item.serviceValue.valueC}"
                            rendered="#{entryController.item.service.type == 'E'}">
                <f:convertNumber type="currency" minFractionDigits="2" pattern="R$ #,##0.00"/>
              </h:outputText>
              <h:outputLabel value="Percentual de ponta:" styleClass="label"
                             rendered="#{entryController.item.service.type == 'E'}"/>
              <h:outputText value="#{entryController.item.serviceValue.valueD}"
                            rendered="#{entryController.item.service.type == 'E'}">
                <f:convertNumber type="percent" minFractionDigits="2"/>
              </h:outputText>
              <h:outputLabel value="Percentual VAH:" styleClass="label"
                             rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}"/>
              <h:outputText value="#{entryController.item.serviceValue.valueD}"
                            rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}">
                <f:convertNumber type="percent" minFractionDigits="2"/>
              </h:outputText>
              <h:outputLabel value="Percentual Terceiros:" styleClass="label"
                             rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}"/>
              <h:outputText value="#{entryController.item.serviceValue.valueA}"
                            rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}">
                <f:convertNumber type="percent" minFractionDigits="2"/>
              </h:outputText>
              <h:outputLabel value="Percentual Consultórios:" styleClass="label"
                             rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}"/>
              <h:outputText value="#{entryController.item.serviceValue.valueB}"
                            rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}">
                <f:convertNumber type="percent" minFractionDigits="2"/>
              </h:outputText>
              <h:outputLabel value="Percentual Shopping:" styleClass="label"
                             rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}"/>
              <h:outputText value="#{entryController.item.serviceValue.valueC}"
                            rendered="#{entryController.item.service.type == 'CR' or entryController.item.service.type == 'CP' or entryController.item.service.type == 'CRE'}">
                <f:convertNumber type="percent" minFractionDigits="2"/>
              </h:outputText>
            </h:panelGrid>
          </h:panelGroup>

          <h:panelGroup style="clear: both;" layout="block"/>

          <!-- MEDIDORES -->

          <p:dataTable id="metersGrid" value="#{entryController.item.meterValues}" var="meter"
                       rendered="#{entryController.item.service.type == 'E'}" styleClass="table-left-header margin-top">
            <f:facet name="header">
              <h:outputText value="Leituras dos Medidores"/>
            </f:facet>
            <p:column headerText="Medidor" styleClass="left-align">
              <h:outputText value="#{meter.consumptionMeter.code}"/>
            </p:column>
            <p:column headerText="Leitura Anterior" styleClass="left-align" width="150">
              <uilance:inputNumber id="previousValue" renderMessage="false"
                                   value="#{meter.previousValue}" editing="#{entryController.editing}"/>
            </p:column>
            <p:column headerText="Leitura Atual" styleClass="left-align" width="150">
              <uilance:inputNumber id="currentValue" renderMessage="false"
                                   value="#{meter.currentValue}" editing="#{entryController.editing}"/>
            </p:column>
            <p:column headerText="Consumo" styleClass="left-align" width="150">
              <h:outputText id="deltaReads" value="#{meter.currentValue - meter.previousValue}"/>
            </p:column>
          </p:dataTable>


          <p:dataTable id="dataTable" var="entryValue"
                       value="#{entryController.entryValues}" styleClass="table-left-header margin-top">
            <f:facet name="header">
              <h:outputText value="Setores"/>
            </f:facet>
            <p:column sortBy="#{entryValue.contractSector.sector.title}" headerText="Setor" styleClass="left-align">
              <h:outputText value="#{entryValue.contractSector.sector.title}"/>
            </p:column>
            <p:column headerText="Categoria" styleClass="left-align" width="100">
              <h:outputText value="-" rendered="#{entryValue.contractSector.sector.sectorDetail == null}"/>
              <h:outputText value="#{entryValue.contractSector.sector.sectorDetail.type.label}"
                            rendered="#{entryValue.contractSector.sector.sectorDetail != null}"/>
            </p:column>
            <p:column headerText="Área (m²)" styleClass="left-align" width="100">
              <h:outputText value="-" rendered="#{entryValue.contractSector.sector.sectorDetail == null}"/>
              <h:outputText value="#{entryValue.contractSector.sector.sectorDetail.area}"
                            rendered="#{entryValue.contractSector.sector.sectorDetail != null}">
                <f:convertNumber minFractionDigits="2" pattern="#,##0.00"/>
              </h:outputText>
            </p:column>
            <p:column headerText="#{entryController.item.service.type.compALabel}" styleClass="left-align" width="150">
              <uilance:inputCurrency id="compValueA" renderMessage="false"
                                     value="#{entryValue.valueA}" editing="#{entryController.editing}"
                                     rendered="#{entryController.item.service.type != 'E'}">
                <p:ajax listener="#{entryController.computeValues}" event="change" process="@this"
                        update=":#{p:component('totalValue')} itemValue"/>
              </uilance:inputCurrency>
              <uilance:inputNumber id="compValueANumber" renderMessage="false"
                                   value="#{entryValue.valueA}" editing="#{entryController.editing}"
                                   rendered="#{entryController.item.service.type == 'E'}">
                <p:ajax listener="#{entryController.computeValues}" event="change" process="@this"
                        update=":#{p:component('totalValue')} itemValue"/>
              </uilance:inputNumber>
            </p:column>
            <p:column headerText="#{entryController.item.service.type.compBLabel}" styleClass="left-align" width="150"
                      rendered="#{entryController.item.service.type.renderCompB}">
              <uilance:inputCurrency id="compValueB" renderMessage="false"
                                     value="#{entryValue.valueB}" editing="#{entryController.editing}"
                                     rendered="#{entryController.item.service.type != 'E'}">
                <p:ajax listener="#{entryController.computeValues}" event="change" process="@this"
                        update=":#{p:component('totalValue')} itemValue"/>
              </uilance:inputCurrency>
              <uilance:inputNumber id="compValueBNumber" renderMessage="false"
                                   value="#{entryValue.valueB}" editing="#{entryController.editing}"
                                   rendered="#{entryController.item.service.type == 'E'}">
                <p:ajax listener="#{entryController.computeValues}" event="change" process="@this"
                        update=":#{p:component('totalValue')} itemValue"/>
              </uilance:inputNumber>
            </p:column>
            <p:column headerText="Valor computado" styleClass="left-align" width="150">
              <h:panelGroup id="itemValue">
                <h:outputText value="#{entryValue.value}">
                  <f:convertNumber type="currency" currencySymbol="R$" minFractionDigits="2" pattern="R$ #,##0.00"/>
                </h:outputText>
              </h:panelGroup>
            </p:column>
          </p:dataTable>

          <ui:include src="commentsBlock.xhtml"/>

          <h:panelGroup id="entrySaveBtnPnl" layout="block"
                        styleClass="margin-top">
            <p:commandButton value="Salvar" icon="ui-icon-check" ajax="true"
                             update="@form" validateClient="true"
                             action="#{entryController.doSave}"
                             rendered="#{entryController.editing and entryController.item.status != 'P' and entryController.item.status != 'V'}"/>
            <p:commandButton value="Salvar" icon="ui-icon-check" ajax="true"
                             update="@form" validateClient="true"
                             action="#{entryController.doFixSave}"
                             rendered="#{entryController.editing and entryController.item.status == 'P'}"/>
            <p:commandButton value="Salvar" icon="ui-icon-check" ajax="true"
                             update="@form" validateClient="true"
                             action="#{entryController.doModifySave}"
                             rendered="#{entryController.editing and entryController.item.status == 'V'}"/>
            <p:commandButton value="Voltar" immediate="true" icon="fa fa-undo"
                             action="#{entryController.back}" styleClass="margin-left"/>
          </h:panelGroup>

        </p:panel>
      </h:panelGroup>
    </h:form>
  </ui:define>
</ui:composition>