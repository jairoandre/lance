<ui:composition template="/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core">
  <ui:define name="content">
    <h:form id="form">
      <p:panel header="Gerar Arquivo de Remessa">
        <div class="ui-messages ui-widget" aria-live="polite">
          <div class="ui-messages-info ui-corner-all">
            <span class="ui-messages-info-icon"/>
            <h:outputText
              value="As cobranças são agrupadas por setor (para serviços condominiais) e data de vencimento. "/>
            <h:outputText value="Para as outras cobranças o agrupamento é realizado por cliente e data de vencimento."/>
          </div>
        </div>
        <h:panelGrid columns="8">
          <p:outputLabel value="Vigência" for="vigencia"/>
          <h:panelGroup>
            <p:inputText id="vigencia" styleClass="searchMonth" value="#{cobrancaCtrl.vigencia}"
                         onclick="this.setSelectionRange(0, this.value.length)"
                         required="true">
              <f:convertDateTime pattern="MM/yyyy" dateStyle="short" timeZone="GMT-0300"/>
            </p:inputText>
            <script>
              $(".searchMonth").mask('99/9999');
            </script>
          </h:panelGroup>
          <p:outputLabel value="Vencimento" for="vencimento"/>
          <h:panelGroup>
            <p:inputText id="vencimento" value="#{cobrancaCtrl.vencimento}"
                         onclick="this.setSelectionRange(0, this.value.length)"/>
            <script>
              $(".vencimento").numberMask();
            </script>
          </h:panelGroup>
          <p:selectBooleanCheckbox id="previa" value="#{cobrancaCtrl.previa}" label="Prévia">
            <p:ajax event="change" process="@this" update="cobrancaPnl" listener="#{cobrancaCtrl.clearCobrancas}"/>
          </p:selectBooleanCheckbox>
          <p:outputLabel for="previa" value="Prévia"/>
          <p:commandButton id="buscarCobrancasBtn" value="Buscar Gravadas"
                           action="#{cobrancaCtrl.buscarCobrancas}" ajax="true" process="@form"
                           onstart="start()"
                           oncomplete="stop()"
                           update="@form"/>
          <p:commandButton id="gerarCobrancasBtn" value="Gerar Cobranças"
                           action="#{cobrancaCtrl.gerarCobrancas}" ajax="true" process="@form"
                           onstart="start()"
                           oncomplete="stop()"
                           update="@form"/>
        </h:panelGrid>

        <h:panelGroup id="cobrancaPnl">
          <p:commandButton id="arquivoRemessaBtn1" value="Remessa Selecionados"
                           ajax="false" process="@form" styleClass="margin-top"
                           onclick="PrimeFaces.monitorDownload(start, stop);">
            <p:fileDownload value="#{cobrancaCtrl.arquivoRemessa}"/>
          </p:commandButton>

          <p:commandButton id="gravarCobrancas1" value="Gravar Selecionados"
                           action="#{cobrancaCtrl.gravarSelecionados}"
                           ajax="true" process="@form" update="@form" styleClass="margin-top margin-left"/>

          <p:commandButton value="Descritivo Selecionados (PDF)"
                           onclick="PrimeFaces.monitorDownload(start, stop);"
                           process="@form"
                           ajax="false"
                           icon="fa fa-building"
                           styleClass="margin-top margin-left">
            <p:fileDownload value="#{cobrancaCtrl.descritivos}"/>
          </p:commandButton>

          <p:commandButton value="Descritivo Selecionados (TXT)"
                           onclick="PrimeFaces.monitorDownload(start, stop);"
                           process="@form"
                           ajax="false"
                           icon="fa fa-building"
                           styleClass="margin-top margin-left">
            <p:fileDownload value="#{cobrancaCtrl.descritivoCobrancas}"/>
          </p:commandButton>

          <p:dataTable id="cobrancaTable" value="#{cobrancaCtrl.cobrancas}" var="cobranca" emptyMessage="Sem cobranças"
                       selection="#{cobrancaCtrl.selectedCobrancas}" rowKey="#{cobranca.rowKey}"
                       disabledSelection="#{cobrancaCtrl.previa}"
                       styleClass="margin-top" rowSelectMode="add">
            <p:column selectionMode="multiple" style="width: 16px; text-align: center;"/>
            <p:column headerText="Id" sortBy="#{cobranca.id}" width="40" styleClass="left-align">
              <h:outputText value="#{cobranca.id}"/>
            </p:column>
            <p:column headerText="Cód." sortBy="#{cobranca.setor.id}" width="50" styleClass="left-align">
              <h:outputText value="#{cobranca.setor.id}"/>
            </p:column>
            <p:column headerText="Setor" sortBy="#{cobranca.setor.title}" width="100"
                      styleClass="left-align ellipsis-text">
              <h:outputText value="#{cobranca.setor.title}"/>
            </p:column>
            <p:column headerText="Cód." sortBy="#{cobranca.cliente.id}" width="50" styleClass="left-align">
              <h:outputText value="#{cobranca.cliente.id}"/>
            </p:column>
            <p:column headerText="Cliente" sortBy="#{cobranca.cliente.title}" styleClass="left-align">
              <h:outputText value="#{cobranca.cliente.title}"/>
            </p:column>
            <p:column headerText="Valor" sortBy="#{cobranca.valor}" width="75" styleClass="right-align">
              <h:outputText value="#{cobranca.valor}">
                <f:convertNumber pattern="R$ #,##0.00" minFractionDigits="2"/>
              </h:outputText>
            </p:column>
            <p:column headerText="Vigên." sortBy="#{cobranca.vigencia}" width="75" styleClass="left-align">
              <h:outputText value="#{cobranca.vigencia}">
                <f:convertDateTime pattern="MM/yyyy"/>
              </h:outputText>
            </p:column>
            <p:column headerText="Venc." sortBy="#{cobranca.vencimento}" width="75" styleClass="left-align">
              <h:outputText value="#{cobranca.vencimento}">
                <f:convertDateTime pattern="dd/MM/yyyy"/>
              </h:outputText>
            </p:column>
            <p:column headerText="Ações" width="80" styleClass="center-align">
              <p:menuButton id="menuButton" value="Ações">
                <p:menuitem value="Descritivo Cond."
                            onclick="PrimeFaces.monitorDownload(start, stop);"
                            ajax="false"
                            rendered="#{not empty cobranca.setor}"
                            icon="fa fa-building">
                  <p:fileDownload value="#{cobrancaCtrl.descritivo(cobranca)}"/>
                </p:menuitem>
                <p:menuitem value="Descritivo Geral"
                            onclick="PrimeFaces.monitorDownload(start, stop);"
                            ajax="false"
                            rendered="#{empty cobranca.setor}"
                            icon="fa fa-building">
                  <p:fileDownload value="#{cobrancaCtrl.descritivoGeral(cobranca)}"/>
                </p:menuitem>
                <p:separator/>
                <p:menuitem value="Baixa contábil" process="@this" update="@this" ajax="true" icon="fa fa-tags"/>
                <p:menuitem value="Nota fiscal"
                            action="#{cobrancaCtrl.preNotaFiscal(cobranca)}"
                            ajax="true"
                            process="@this"
                            update="#{p:component('nfDlgWrapper')}"
                            oncomplete="PF('nfDlg').show()"
                            disabled="#{empty cobranca.id}"
                            icon="fa fa-ticket"/>
              </p:menuButton>
            </p:column>
          </p:dataTable>
          <p:commandButton id="arquivoRemessaBtn2" value="Remessa Selecionados"
                           ajax="false" process="@form" styleClass="margin-top"
                           onclick="PrimeFaces.monitorDownload(start, stop);">
            <p:fileDownload value="#{cobrancaCtrl.arquivoRemessa}"/>
          </p:commandButton>
          <p:commandButton id="gravarCobrancas2" value="Gravar Selecionados"
                           action="#{cobrancaCtrl.gravarSelecionados}"
                           ajax="true" process="@form" update="@form" styleClass="margin-top margin-left"/>
        </h:panelGroup>
        <h:panelGroup id="nfDlgWrapper">
          <p:dialog id="nfDlg" widgetVar="nfDlg"
                    header="Informar Nº. Nota Fiscal"
                    width="800" height="400"
                    rendered="#{not empty cobrancaCtrl.cobranca}">
            <h:panelGrid columns="4">
              <p:outputLabel value="Cliente:" for="clienteMVDlg" styleClass="lance-label"/>
              <h:outputText id="clienteMVDlg" value="#{cobrancaCtrl.cobranca.cliente.title}"/>
              <p:outputLabel value="Setor:" for="setorMVDlg" styleClass="lance-label"/>
              <h:outputText id="setorMVDlg" value="#{empty cobrancaCtrl.cobranca.setor ? '-' : cobrancaCtrl.cobranca.setor.title}"/>
              <p:outputLabel value="Valor total:" for="valorTotalDlg" styleClass="lance-label"/>
              <h:outputText id="valorTotalDlg" value="#{cobrancaCtrl.cobranca.valor}">
                <f:convertNumber pattern="R$ #,##0.00"/>
              </h:outputText>
            </h:panelGrid>
            <p:dataGrid id="nfGrid" value="#{cobrancaCtrl.cobranca.contas.toArray()}" var="contaReceber" columns="1"
                        styleClass="margin-top" rowIndexVar="idx">
              <h:panelGrid columns="2">
                <p:outputLabel id="idMVLabel" value="Cód.:" for="idMVOutput" styleClass="lance-label"/>
                <h:outputText id="idMVOutput" value="#{contaReceber.id}"/>
                <p:outputLabel id="valorLabel" value="Valor:" for="valorOutput" styleClass="lance-label"/>
                <h:outputText id="valorOutput" value="#{contaReceber.valorBruto}">
                  <f:convertNumber pattern="R$ #,##0.00"/>
                </h:outputText>
                <p:outputLabel id="contaMVLabel" value="Conta:" for="contaMVOutput" styleClass="lance-label"/>
                <h:outputText id="contaMVOutput" value="#{contaReceber.contaContabil.title}"/>
                <p:outputLabel id="descLabel" value="Descrição:" for="descOutput" styleClass="lance-label"/>
                <h:outputText id="descOutput" value="#{contaReceber.descricao}"/>
                <p:outputLabel id="nfLabel" value="Nº. Documento:" for="nfInput" styleClass="lance-label"/>
                <p:inputText id="nfInput" value="#{contaReceber.numeroDocumento}"/>
              </h:panelGrid>
              <p:separator rendered="#{idx lt (cobrancaCtrl.cobranca.contas.size() - 1)}"/>
            </p:dataGrid>
            <f:facet name="footer">
              <p:commandButton id="cobrancaNfBtn" value="Salvar"
                               action="#{cobrancaCtrl.salvarContaReceber}"
                               oncomplete="PF('nfDlg').hide()"
                               ajax="true" process="nfDlg" update="@all"/>
              <p:commandButton id="calcenNfDlg" value="Cancelar"
                               ajax="true" process="@this" oncomplete="PF('nfDlg').hide()"
                               styleClass="margin-left"/>
            </f:facet>
          </p:dialog>
        </h:panelGroup>
      </p:panel>
    </h:form>
  </ui:define>
</ui:composition>